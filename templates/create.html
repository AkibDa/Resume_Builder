{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <div class="text-center">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Create Resume from Scratch</h1>
        <p class="text-lg text-gray-600">Fill in your details to create a professional resume</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <form id="createResumeForm" class="space-y-6">
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900">Personal Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" id="firstName" name="firstName" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" id="lastName" name="lastName" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" name="email" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="phone" name="phone" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" id="location" name="location" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Professional Summary</h3>
                    <textarea id="summary" name="summary" rows="4" required
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                        placeholder="Write a brief professional summary..."></textarea>
                </div>

                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Work Experience</h3>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="isFresher" name="isFresher" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="isFresher" class="ml-2 block text-sm text-gray-700">
                            I am a fresher (no work experience)
                        </label>
                    </div>
                    <div id="experienceContainer" class="space-y-4">
                        <div class="experience-entry p-4 border rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Company</label>
                                    <input type="text" name="company[]" 
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Position</label>
                                    <input type="text" name="position[]" 
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                                    <input type="date" name="startDate[]" 
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                                    <input type="date" name="endDate[]" 
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">Responsibilities</label>
                                <textarea name="responsibilities[]" rows="3" 
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                    placeholder="List your key responsibilities and achievements..."></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addExperience"
                        class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-plus mr-2"></i> Add Experience
                    </button>
                </div>

                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Education</h3>
                    <div id="educationContainer" class="space-y-4">
                        <div class="education-entry p-4 border rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Institution</label>
                                    <input type="text" name="institution[]" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Degree</label>
                                    <input type="text" name="degree[]" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                                    <input type="date" name="eduStartDate[]" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                                    <input type="date" name="eduEndDate[]" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addEducation"
                        class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-plus mr-2"></i> Add Education
                    </button>
                </div>

                <!-- Skills -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Skills</h3>
                    <div id="skillsContainer" class="space-y-4">
                        <div class="skills-entry p-4 border rounded-lg">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Technical Skills</label>
                                <input type="text" name="technicalSkills[]" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                    placeholder="e.g., Python, JavaScript, SQL">
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">Soft Skills</label>
                                <input type="text" name="softSkills[]" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                    placeholder="e.g., Leadership, Communication, Problem Solving">
                            </div>
                        </div>
                    </div>
                    <button type="button" id="addSkills"
                        class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-plus mr-2"></i> Add Skills
                    </button>
                </div>

                <!-- Template Selection -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Choose Template</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="modern">
                            <div class="text-center">
                                <i class="fas fa-file-alt text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Modern</h3>
                                <p class="text-xs text-gray-500">Clean & Professional</p>
                            </div>
                        </div>
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="classic">
                            <div class="text-center">
                                <i class="fas fa-file-word text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Classic</h3>
                                <p class="text-xs text-gray-500">Traditional</p>
                            </div>
                        </div>
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="creative">
                            <div class="text-center">
                                <i class="fas fa-paint-brush text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Creative</h3>
                                <p class="text-xs text-gray-500">Unique & Bold</p>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selectedTemplate" name="template" value="modern">
                </div>

                <!-- Submit Button -->
                <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-magic mr-2"></i> Generate Resume
                </button>
            </form>

            <!-- Loading State -->
            <div id="loading" class="hidden mt-4">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <span class="ml-2 text-gray-600">Generating your resume...</span>
                </div>
            </div>

            <!-- Error Alert -->
            <div id="errorAlert" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-md"></div>
        </div>

        <!-- Preview Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Resume Preview</h2>
            <div id="previewArea" class="resume-preview p-6 bg-gray-50 rounded-lg border border-gray-200 min-h-[500px] font-sans">
                <div class="text-center text-gray-500">
                    <i class="fas fa-file-alt text-4xl mb-2"></i>
                    <p>Your resume preview will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get DOM elements
    const createResumeForm = document.getElementById('createResumeForm');
    const experienceContainer = document.getElementById('experienceContainer');
    const educationContainer = document.getElementById('educationContainer');
    const skillsContainer = document.getElementById('skillsContainer');
    const addExperienceBtn = document.getElementById('addExperience');
    const addEducationBtn = document.getElementById('addEducation');
    const addSkillsBtn = document.getElementById('addSkills');
    const selectedTemplate = document.getElementById('selectedTemplate');
    const errorAlert = document.getElementById('errorAlert');
    const loadingIndicator = document.getElementById('loading');
    const previewArea = document.getElementById('previewArea');
    const isFresherCheckbox = document.getElementById('isFresher');

    // Handle fresher checkbox
    if (isFresherCheckbox) {
        isFresherCheckbox.addEventListener('change', (e) => {
            if (experienceContainer) {
                experienceContainer.style.display = e.target.checked ? 'none' : 'block';
            }
            if (addExperienceBtn) {
                addExperienceBtn.style.display = e.target.checked ? 'none' : 'inline-flex';
            }
        });
    }

    // Template selection
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.template-card').forEach(c => {
                c.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
            card.classList.add('border-indigo-500', 'bg-indigo-50');
            if (selectedTemplate) {
                selectedTemplate.value = card.dataset.template;
            }
        });
    });

    // Add Experience Entry
    addExperienceBtn.addEventListener('click', () => {
        const entry = document.createElement('div');
        entry.className = 'experience-entry p-4 border rounded-lg';
        entry.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Company</label>
                    <input type="text" name="company[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Position</label>
                    <input type="text" name="position[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" name="startDate[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" name="endDate[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">Responsibilities</label>
                <textarea name="responsibilities[]" rows="3" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                    placeholder="List your key responsibilities and achievements..."></textarea>
            </div>
            <button type="button" class="remove-entry mt-4 text-red-600 hover:text-red-800">
                <i class="fas fa-trash mr-1"></i> Remove
            </button>
        `;
        experienceContainer.appendChild(entry);
    });

    // Add Education Entry
    addEducationBtn.addEventListener('click', () => {
        const entry = document.createElement('div');
        entry.className = 'education-entry p-4 border rounded-lg';
        entry.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Institution</label>
                    <input type="text" name="institution[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Degree</label>
                    <input type="text" name="degree[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" name="eduStartDate[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" name="eduEndDate[]" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>
            <button type="button" class="remove-entry mt-4 text-red-600 hover:text-red-800">
                <i class="fas fa-trash mr-1"></i> Remove
            </button>
        `;
        educationContainer.appendChild(entry);
    });

    // Add Skills Entry
    addSkillsBtn.addEventListener('click', () => {
        const entry = document.createElement('div');
        entry.className = 'skills-entry p-4 border rounded-lg';
        entry.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-gray-700">Technical Skills</label>
                <input type="text" name="technicalSkills[]" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                    placeholder="e.g., Python, JavaScript, SQL">
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">Soft Skills</label>
                <input type="text" name="softSkills[]" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                    placeholder="e.g., Leadership, Communication, Problem Solving">
            </div>
            <button type="button" class="remove-entry mt-4 text-red-600 hover:text-red-800">
                <i class="fas fa-trash mr-1"></i> Remove
            </button>
        `;
        skillsContainer.appendChild(entry);
    });

    // Remove Entry
    document.addEventListener('click', (e) => {
        if (e.target.closest('.remove-entry')) {
            e.target.closest('.experience-entry, .education-entry, .skills-entry').remove();
        }
    });

    // Form submission
    if (createResumeForm) {
        createResumeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (errorAlert) errorAlert.classList.add('hidden');
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    
            try {
                const formData = new FormData(createResumeForm);
                const data = {
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    location: formData.get('location'),
                    summary: formData.get('summary'),
                    isFresher: formData.get('isFresher') === 'on',
                    template: formData.get('template'),
                    companies: formData.getAll('company[]').filter(Boolean),
                    positions: formData.getAll('position[]').filter(Boolean),
                    startDates: formData.getAll('startDate[]').filter(Boolean),
                    endDates: formData.getAll('endDate[]').filter(Boolean),
                    responsibilities: formData.getAll('responsibilities[]').filter(Boolean),
                    institutions: formData.getAll('institution[]').filter(Boolean),
                    degrees: formData.getAll('degree[]').filter(Boolean),
                    eduStartDates: formData.getAll('eduStartDate[]').filter(Boolean),
                    eduEndDates: formData.getAll('eduEndDate[]').filter(Boolean),
                    technicalSkills: formData.getAll('technicalSkills[]').filter(Boolean),
                    softSkills: formData.getAll('softSkills[]').filter(Boolean)
                  };
    
                // Process arrays
                if (!data.isFresher) {
                    data.companies = formData.getAll('company[]');
                    data.positions = formData.getAll('position[]');
                    data.startDates = formData.getAll('startDate[]');
                    data.endDates = formData.getAll('endDate[]');
                    data.responsibilities = formData.getAll('responsibilities[]');
                } else {
                    // If fresher, set empty arrays for work experience
                    data.companies = [];
                    data.positions = [];
                    data.startDates = [];
                    data.endDates = [];
                    data.responsibilities = [];
                }
    
                data.institutions = formData.getAll('institution[]');
                data.degrees = formData.getAll('degree[]');
                data.eduStartDates = formData.getAll('eduStartDate[]');
                data.eduEndDates = formData.getAll('eduEndDate[]');
                data.technicalSkills = formData.getAll('technicalSkills[]');
                data.softSkills = formData.getAll('softSkills[]');
    
                console.log('Submitting data:', {
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    location: formData.get('location'),
                    summary: formData.get('summary'),
                    isFresher: formData.get('isFresher') === 'on',
                    template: formData.get('template'),
                    companies: formData.getAll('company[]'),
                    positions: formData.getAll('position[]'),
                    startDates: formData.getAll('startDate[]'),
                    endDates: formData.getAll('endDate[]'),
                    responsibilities: formData.getAll('responsibilities[]'),
                    institutions: formData.getAll('institution[]'),
                    degrees: formData.getAll('degree[]'),
                    eduStartDates: formData.getAll('eduStartDate[]'),
                    eduEndDates: formData.getAll('eduEndDate[]'),
                    technicalSkills: formData.getAll('technicalSkills[]'),
                    softSkills: formData.getAll('softSkills[]')
                }); // Debug log
    
                // Generate resume
                const response = await fetch('/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
    
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
    
                const result = await response.json();
                console.log('Response:', result); // Debug log
    
                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate resume');
                }
    
                // Update preview
                if (previewArea) {
                    previewArea.innerHTML = result.resume.replace(/\n/g, '<br>');
                }
    
                // Create download links if they don't exist
                let downloadLinks = document.getElementById('downloadLinks');
                if (!downloadLinks) {
                    downloadLinks = document.createElement('div');
                    downloadLinks.id = 'downloadLinks';
                    downloadLinks.className = 'mt-4 space-y-2';
                    previewArea.parentNode.insertBefore(downloadLinks, previewArea.nextSibling);
                }
    
                // Update download links
                downloadLinks.innerHTML = `
                    <div class="flex space-x-4">
                        <a href="${result.pdf_path}" download
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-file-pdf mr-2"></i> Download PDF
                        </a>
                        <a href="${result.docx_path}" download
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-file-word mr-2"></i> Download DOCX
                        </a>
                    </div>
                `;
    
                // Scroll to preview section
                previewArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
            } catch (error) {
                console.error('Error:', error);
                if (errorAlert) {
                    errorAlert.textContent = error.message;
                    errorAlert.classList.remove('hidden');
                }
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            }
        });
    }
</script>
{% endblock %} 