{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <!-- Header Section -->
    <div class="text-center">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">AI Resume Builder</h1>
        <p class="text-lg text-gray-600">Create a professional resume tailored to your dream job</p>
    </div>

    <!-- Main Form Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Input Form -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <form id="resumeForm" class="space-y-6">
                <!-- Resume Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Upload Your Resume (PDF)
                    </label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                        <div class="space-y-1 text-center">
                            <i class="fas fa-file-upload text-gray-400 text-3xl mb-2"></i>
                            <div class="flex text-sm text-gray-600">
                                <label for="resume" class="relative cursor-pointer rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-500 focus-within:ring-offset-2">
                                    <span>Upload a file</span>
                                    <input id="resume" name="resume" type="file" class="sr-only" accept=".pdf">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PDF up to 16MB</p>
                        </div>
                    </div>
                    <div id="uploadStatus" class="mt-2 text-sm text-gray-500"></div>
                </div>

                <!-- Job Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Job Description
                    </label>
                    <div class="relative">
                        <textarea id="jobDescription" name="job_description" rows="4" 
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                            placeholder="Paste the job description here..."></textarea>
                        <div id="suggestionBox" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden">
                            <!-- Suggestions will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Template Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Choose Template
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="modern">
                            <div class="text-center">
                                <i class="fas fa-file-alt text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Modern</h3>
                                <p class="text-xs text-gray-500">Clean & Professional</p>
                            </div>
                        </div>
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="classic">
                            <div class="text-center">
                                <i class="fas fa-file-word text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Classic</h3>
                                <p class="text-xs text-gray-500">Traditional</p>
                            </div>
                        </div>
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="creative">
                            <div class="text-center">
                                <i class="fas fa-paint-brush text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Creative</h3>
                                <p class="text-xs text-gray-500">Unique & Bold</p>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selectedTemplate" name="template" value="modern">
                </div>

                <!-- Submit Button -->
                <button type="submit" 
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-magic mr-2"></i> Generate Resume
                </button>
            </form>

            <!-- Loading State -->
            <div id="loading" class="hidden mt-4">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <span class="ml-2 text-gray-600">Generating your resume...</span>
                </div>
            </div>

            <!-- Error Alert -->
            <div id="errorAlert" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-md"></div>
        </div>

        <!-- Preview Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Resume Preview</h2>
            <div id="previewArea" class="resume-preview p-6">
                <div class="text-center text-gray-500">
                    <i class="fas fa-file-alt text-4xl mb-2"></i>
                    <p>Your resume preview will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ATS Optimization Section -->
    <div id="atsOptimization" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-search text-indigo-500 mr-2"></i>ATS Optimization Results
            </h2>
            <div class="space-y-4">
                <div class="p-4 bg-indigo-50 rounded-lg">
                    <h3 class="text-sm font-medium text-indigo-800 mb-2">Key Skills & Keywords</h3>
                    <div id="resumeKeywords" class="flex flex-wrap gap-2">
                        <!-- Keywords will be populated here -->
                    </div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <h3 class="text-sm font-medium text-green-800 mb-2">Grammar & Phrasing Improvements</h3>
                    <p class="text-sm text-green-700">Your resume has been optimized for clarity and impact.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Matches Section -->
    <div id="jobMatches" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-briefcase text-blue-500 mr-2"></i>Recommended Job Matches
            </h2>
            <div id="jobMatchesContent" class="space-y-4">
                <!-- Job matches will be populated here -->
            </div>
        </div>
    </div>

    <!-- Green Job Opportunities Section -->
    <div id="greenOpportunities" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-leaf text-green-500 mr-2"></i>Green Job Opportunities
            </h2>
            <div id="greenOpportunitiesContent" class="space-y-4">
                <!-- Green opportunities will be populated here -->
            </div>
        </div>
    </div>

    <!-- Result Section -->
    <div id="resultArea" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Your Enhanced Resume</h2>
            <div class="space-y-4">
                <div id="generatedResume" class="prose max-w-none"></div>
                
                <!-- Blockchain Verification -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">
                        <i class="fas fa-shield-alt text-indigo-500 mr-2"></i>Blockchain Verification
                    </h3>
                    <p class="text-sm text-gray-600 mb-2">Your resume has been verified and stored on the blockchain.</p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded" id="verificationHash"></span>
                        <button onclick="copyVerificationHash()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- Download Options -->
                <div class="flex justify-center space-x-4">
                    <a id="downloadPdf" href="#" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        <i class="fas fa-file-pdf mr-2"></i> Download PDF
                    </a>
                    <a id="downloadDocx" href="#" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-file-word mr-2"></i> Download DOCX
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Template selection
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('border-indigo-500', 'bg-indigo-50'));
            card.classList.add('border-indigo-500', 'bg-indigo-50');
            document.getElementById('selectedTemplate').value = card.dataset.template;
        });
    });

    // Job description suggestions
    const suggestions = [
        "Experienced software developer with strong problem-solving skills",
        "Detail-oriented project manager with excellent communication abilities",
        "Creative designer with expertise in UI/UX",
        "Data analyst with experience in statistical analysis",
        "Marketing professional with proven track record",
        "Sales representative with strong negotiation skills",
        "Customer service specialist with focus on client satisfaction",
        "Financial analyst with expertise in risk management",
        "HR professional with experience in talent acquisition",
        "Operations manager with process optimization skills"
    ];

    const jobDescription = document.getElementById('jobDescription');
    const suggestionBox = document.getElementById('suggestionBox');

    jobDescription.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase();
        if (value.length < 3) {
            suggestionBox.classList.add('hidden');
            return;
        }

        const filteredSuggestions = suggestions.filter(s => 
            s.toLowerCase().includes(value)
        );

        if (filteredSuggestions.length > 0) {
            suggestionBox.innerHTML = filteredSuggestions
                .map(s => `<div class="suggestion-item p-2 hover:bg-gray-100 cursor-pointer">${s}</div>`)
                .join('');
            suggestionBox.classList.remove('hidden');
        } else {
            suggestionBox.classList.add('hidden');
        }
    });

    suggestionBox.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-item')) {
            jobDescription.value = e.target.textContent;
            suggestionBox.classList.add('hidden');
        }
    });

    // Form submission
    document.getElementById('resumeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData();
        const resumeFile = document.getElementById('resume').files[0];
        const jobDescription = document.getElementById('jobDescription').value;
        const template = document.getElementById('selectedTemplate').value;

        if (!resumeFile) {
            showError('Please upload a resume file');
            return;
        }

        if (!jobDescription) {
            showError('Please enter a job description');
            return;
        }

        formData.append('resume', resumeFile);
        formData.append('job_description', jobDescription);
        formData.append('template', template);

        // Show loading state
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('errorAlert').classList.add('hidden');
        document.getElementById('resultArea').classList.add('hidden');
        document.getElementById('greenOpportunities').classList.add('hidden');
        document.getElementById('atsOptimization').classList.add('hidden');
        document.getElementById('jobMatches').classList.add('hidden');

        try {
            // Upload resume
            const uploadResponse = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const uploadData = await uploadResponse.json();

            if (!uploadResponse.ok) {
                throw new Error(uploadData.error || 'Failed to upload resume');
            }

            // Generate resume
            const generateResponse = await fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    resume: uploadData.resume_text,
                    job_description: jobDescription,
                    template: template
                })
            });
            const generateData = await generateResponse.json();

            if (!generateResponse.ok) {
                throw new Error(generateData.error || 'Failed to generate resume');
            }

            // Update preview and result area
            document.getElementById('generatedResume').innerHTML = generateData.resume.replace(/\n/g, '<br>');
            document.getElementById('previewArea').innerHTML = generateData.resume.replace(/\n/g, '<br>');
            document.getElementById('downloadPdf').href = generateData.pdf_path;
            document.getElementById('downloadDocx').href = generateData.docx_path;
            document.getElementById('verificationHash').textContent = generateData.verification_hash;

            // Display ATS optimization results
            if (generateData.resume_keywords) {
                const keywordsContainer = document.getElementById('resumeKeywords');
                keywordsContainer.innerHTML = generateData.resume_keywords
                    .map(keyword => `
                        <span class="px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">
                            ${keyword}
                        </span>
                    `).join('');
                document.getElementById('atsOptimization').classList.remove('hidden');
            }

            // Display job matches
            if (generateData.job_matches && generateData.job_matches.length > 0) {
                const jobMatchesContent = document.getElementById('jobMatchesContent');
                jobMatchesContent.innerHTML = generateData.job_matches
                    .map(match => `
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-sm font-medium text-blue-800">${match.industry}</h3>
                                <span class="text-sm font-medium text-blue-600">${match.match_percentage}% Match</span>
                            </div>
                            <p class="text-sm text-blue-700 mb-2">${match.recommendation}</p>
                            <div class="flex flex-wrap gap-2">
                                ${match.matching_keywords.map(keyword => `
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                        ${keyword}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                document.getElementById('jobMatches').classList.remove('hidden');
            }

            // Display green job opportunities
            if (generateData.green_opportunities && generateData.green_opportunities.length > 0) {
                const greenOpportunitiesContent = document.getElementById('greenOpportunitiesContent');
                greenOpportunitiesContent.innerHTML = generateData.green_opportunities.map(opportunity => `
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h3 class="text-sm font-medium text-green-800 mb-2">${opportunity.category}</h3>
                        <p class="text-sm text-green-700 mb-2">${opportunity.recommendation}</p>
                        <div class="flex flex-wrap gap-2">
                            ${opportunity.keywords.map(keyword => `
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    ${keyword}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('greenOpportunities').classList.remove('hidden');
            }

            document.getElementById('resultArea').classList.remove('hidden');

        } catch (error) {
            showError(error.message);
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    });

    function showError(message) {
        const errorAlert = document.getElementById('errorAlert');
        errorAlert.textContent = message;
        errorAlert.classList.remove('hidden');
    }

    function copyVerificationHash() {
        const hashElement = document.getElementById('verificationHash');
        navigator.clipboard.writeText(hashElement.textContent).then(() => {
            const button = hashElement.nextElementSibling;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
        });
    }

    // File upload preview
    document.getElementById('resume').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('uploadStatus').textContent = `Selected file: ${file.name}`;
        }
    });
</script>
{% endblock %} 