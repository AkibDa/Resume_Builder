{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <!-- Header Section -->
    <div class="text-center">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">AI Resume Builder</h1>
        <p class="text-lg text-gray-600">Create a professional resume tailored to your dream job</p>
    </div>

    <!-- Main Form Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Input Form -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <form id="resumeForm" class="space-y-6">
                <!-- Resume Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Upload Your Resume (PDF)
                    </label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                        <div class="space-y-1 text-center">
                            <i class="fas fa-file-upload text-gray-400 text-3xl mb-2"></i>
                            <div class="flex text-sm text-gray-600">
                                <label for="resume" class="relative cursor-pointer rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-500 focus-within:ring-offset-2">
                                    <span>Upload a file</span>
                                    <input id="resume" name="resume" type="file" class="sr-only" accept=".pdf">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PDF up to 16MB</p>
                        </div>
                    </div>
                    <div id="uploadStatus" class="mt-2 text-sm text-gray-500"></div>
                </div>

                <!-- Job Description -->
                <div class="mb-6">
                    <label for="job_description" class="block text-sm font-medium text-gray-700 mb-2">Job Description</label>
                    <textarea id="job_description" name="job_description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Paste the job description here..."></textarea>
                    <div id="job_suggestions" class="mt-2 text-sm text-gray-600"></div>
                </div>

                <!-- Resume Textarea -->
                <div class="mb-6">
                    <label for="resume" class="block text-sm font-medium text-gray-700 mb-2">Your Resume</label>
                    <div class="relative">
                        <textarea id="resume" name="resume" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Paste your resume here..."></textarea>
                        <div class="absolute right-2 top-2">
                            <select id="resume_section" class="text-sm border border-gray-300 rounded-md px-2 py-1 bg-white">
                                <option value="general">General</option>
                                <option value="experience">Experience</option>
                                <option value="education">Education</option>
                                <option value="skills">Skills</option>
                            </select>
                        </div>
                    </div>
                    <div id="resume_suggestions" class="mt-2 text-sm text-gray-600"></div>
                </div>

                <!-- Template Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Choose Template
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="modern">
                            <div class="text-center">
                                <i class="fas fa-file-alt text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Modern</h3>
                                <p class="text-xs text-gray-500">Clean & Professional</p>
                            </div>
                        </div>
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="classic">
                            <div class="text-center">
                                <i class="fas fa-file-word text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Classic</h3>
                                <p class="text-xs text-gray-500">Traditional</p>
                            </div>
                        </div>
                        <div class="template-card p-4 border rounded-lg cursor-pointer" data-template="creative">
                            <div class="text-center">
                                <i class="fas fa-paint-brush text-2xl text-indigo-600 mb-2"></i>
                                <h3 class="text-sm font-medium">Creative</h3>
                                <p class="text-xs text-gray-500">Unique & Bold</p>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selectedTemplate" name="template" value="modern">
                </div>

                <!-- Submit Button -->
                <button type="submit" 
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-magic mr-2"></i> Generate Resume
                </button>
            </form>

            <!-- Loading State -->
            <div id="loading" class="hidden mt-4">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <span class="ml-2 text-gray-600">Generating your resume...</span>
                </div>
            </div>

            <!-- Error Alert -->
            <div id="errorAlert" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-md"></div>

            <!-- Suggestions Panel -->
            <div id="suggestions_panel" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">AI Suggestions</h3>
                <div id="suggestions_content" class="space-y-2">
                    <!-- Suggestions will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Resume Preview</h2>
            <div id="previewArea" class="resume-preview p-6">
                <div class="text-center text-gray-500">
                    <i class="fas fa-file-alt text-4xl mb-2"></i>
                    <p>Your resume preview will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ATS Optimization Section -->
    <div id="atsOptimization" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-search text-indigo-500 mr-2"></i>ATS Optimization Results
            </h2>
            <div class="space-y-4">
                <div class="p-4 bg-indigo-50 rounded-lg">
                    <h3 class="text-sm font-medium text-indigo-800 mb-2">Key Skills & Keywords</h3>
                    <div id="resumeKeywords" class="flex flex-wrap gap-2">
                        <!-- Keywords will be populated here -->
                    </div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <h3 class="text-sm font-medium text-green-800 mb-2">Grammar & Phrasing Improvements</h3>
                    <p class="text-sm text-green-700">Your resume has been optimized for clarity and impact.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Matches Section -->
    <div id="jobMatches" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-briefcase text-blue-500 mr-2"></i>Recommended Job Matches
            </h2>
            <div id="jobMatchesContent" class="space-y-4">
                <!-- Job matches will be populated here -->
            </div>
        </div>
    </div>

    <!-- Green Job Opportunities Section -->
    <div id="greenOpportunities" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-leaf text-green-500 mr-2"></i>Green Job Opportunities
            </h2>
            <div id="greenOpportunitiesContent" class="space-y-4">
                <!-- Green opportunities will be populated here -->
            </div>
        </div>
    </div>

    <!-- Result Section -->
    <div id="resultArea" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Your Enhanced Resume</h2>
            <div class="space-y-4">
                <div id="generatedResume" class="prose max-w-none"></div>
                
                <!-- Blockchain Verification -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">
                        <i class="fas fa-shield-alt text-indigo-500 mr-2"></i>Blockchain Verification
                    </h3>
                    <p class="text-sm text-gray-600 mb-2">Your resume has been verified and stored on the blockchain.</p>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded" id="verificationHash"></span>
                        <button onclick="copyVerificationHash()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- Download Options -->
                <div class="flex justify-center space-x-4">
                    <a id="downloadPdf" href="#" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        <i class="fas fa-file-pdf mr-2"></i> Download PDF
                    </a>
                    <a id="downloadDocx" href="#" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-file-word mr-2"></i> Download DOCX
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get DOM elements
    const resumeFile = document.getElementById('resume');
    const jobDescriptionInput = document.getElementById('job_description');
    const suggestionBox = document.getElementById('job_suggestions');
    const selectedTemplate = document.getElementById('selectedTemplate');
    const errorAlert = document.getElementById('errorAlert');
    const resultSection = document.getElementById('resultSection');
    const previewContent = document.getElementById('previewContent');
    const resumeTextarea = document.getElementById('resume');
    const resumeSection = document.getElementById('resume_section');
    
    // Template selection
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('border-indigo-500', 'bg-indigo-50'));
            card.classList.add('border-indigo-500', 'bg-indigo-50');
            selectedTemplate.value = card.dataset.template;
        });
    });
    
    // Job description suggestions
    const jobSuggestions = [
        "Software engineer with full-stack development experience",
        "Data analyst with machine learning expertise",
        "Marketing manager with digital marketing skills",
        "Financial analyst with risk management experience",
        "Healthcare administrator with patient care background",
        "Sales representative with client relationship skills",
        "HR manager with talent acquisition experience",
        "Operations manager with process optimization skills"
    ];
    
    jobDescriptionInput.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase();
        if (value.length < 3) {
            suggestionBox.classList.add('hidden');
            return;
        }
        
        const matches = jobSuggestions.filter(suggestion => 
            suggestion.toLowerCase().includes(value)
        );
        
        if (matches.length > 0) {
            suggestionBox.innerHTML = matches.map(suggestion => 
                `<div class="suggestion-item p-2 hover:bg-gray-100 cursor-pointer">${suggestion}</div>`
            ).join('');
            suggestionBox.classList.remove('hidden');
        } else {
            suggestionBox.classList.add('hidden');
        }
    });
    
    suggestionBox.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-item')) {
            jobDescriptionInput.value = e.target.textContent;
            suggestionBox.classList.add('hidden');
        }
    });
    
    // Form submission
    document.getElementById('resumeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        errorAlert.classList.add('hidden');
        
        try {
            const formData = new FormData();
            const resumeFile = document.getElementById('resume').files[0];
            const jobDescription = jobDescriptionInput.value;
            const template = selectedTemplate.value;
            
            if (!resumeFile) {
                throw new Error('Please upload a resume file');
            }
            
            if (!jobDescription) {
                throw new Error('Please enter a job description');
            }
            
            formData.append('resume', resumeFile);
            
            // First upload the resume
            const uploadResponse = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const uploadData = await uploadResponse.json();
            if (!uploadData.success) {
                throw new Error(uploadData.error || 'Failed to upload resume');
            }
            
            // Then generate the resume
            const generateResponse = await fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    resume: uploadData.resume_text,
                    job_description: jobDescription,
                    template: template
                })
            });
            
            const generateData = await generateResponse.json();
            if (!generateData.success) {
                throw new Error(generateData.error || 'Failed to generate resume');
            }
            
            // Update preview
            previewContent.innerHTML = generateData.resume.replace(/\n/g, '<br>');
            resultSection.classList.remove('hidden');
            
            // Scroll to result section
            resultSection.scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            errorAlert.textContent = error.message;
            errorAlert.classList.remove('hidden');
        }
    });
    
    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Function to get AI suggestions
    async function getSuggestions(text, section) {
        try {
            const response = await fetch('/suggest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text, section })
            });
            
            const data = await response.json();
            if (data.success) {
                return data.suggestions;
            }
            return null;
        } catch (error) {
            console.error('Error getting suggestions:', error);
            return null;
        }
    }
    
    // Function to update suggestions panel
    function updateSuggestionsPanel(suggestions) {
        const panel = document.getElementById('suggestions_panel');
        const content = document.getElementById('suggestions_content');
        
        if (suggestions) {
            panel.classList.remove('hidden');
            content.innerHTML = suggestions.split('\n').map(suggestion => 
                `<p class="text-gray-700">• ${suggestion}</p>`
            ).join('');
        } else {
            panel.classList.add('hidden');
        }
    }
    
    // Debounced function for resume suggestions
    const debouncedResumeSuggestions = debounce(async (text, section) => {
        if (text.trim().length > 50) {  // Only get suggestions for substantial text
            const suggestions = await getSuggestions(text, section);
            updateSuggestionsPanel(suggestions);
        } else {
            updateSuggestionsPanel(null);
        }
    }, 1000);
    
    // Debounced function for job description suggestions
    const debouncedJobSuggestions = debounce(async (text) => {
        if (text.trim().length > 50) {  // Only get suggestions for substantial text
            const suggestions = await getSuggestions(text, 'general');
            document.getElementById('job_suggestions').innerHTML = suggestions ? 
                suggestions.split('\n').map(s => `<p class="text-gray-700">• ${s}</p>`).join('') : '';
        } else {
            document.getElementById('job_suggestions').innerHTML = '';
        }
    }, 1000);
    
    // Add event listeners for real-time suggestions
    resumeTextarea.addEventListener('input', () => {
        debouncedResumeSuggestions(resumeTextarea.value, resumeSection.value);
    });
    
    resumeSection.addEventListener('change', () => {
        debouncedResumeSuggestions(resumeTextarea.value, resumeSection.value);
    });
    
    jobDescriptionInput.addEventListener('input', () => {
        debouncedJobSuggestions(jobDescriptionInput.value);
    });

    function copyVerificationHash() {
        const hashElement = document.getElementById('verificationHash');
        navigator.clipboard.writeText(hashElement.textContent).then(() => {
            const button = hashElement.nextElementSibling;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
        });
    }

    // File upload preview
    document.getElementById('resume').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('uploadStatus').textContent = `Selected file: ${file.name}`;
        }
    });
</script>
{% endblock %} 